<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sublime - Finalizar Pagamento">
  <title>Finalizar Pagamento - Sublime</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Allura&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ============================================
       CSS VARIABLES & THEME
       ============================================ */
    :root {
      --pink: #ff6fb5;
      --lilac: #c7aefc;
      --white: #ffffff;
      --muted: #f6f3f8;
      --dark-blue: #0b2340;
      --text: #222;
      --shadow: rgba(0, 0, 0, 0.1);
      --overlay: rgba(0, 0, 0, 0.5);
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
      
      --bg-primary: var(--white);
      --bg-secondary: var(--muted);
      --text-primary: var(--text);
      --text-secondary: #666;
      --accent: var(--pink);
      --accent-secondary: var(--lilac);
      --border: #e0e0e0;
      --card-bg: var(--white);
    }
    
    body.dark-theme {
      --bg-primary: var(--dark-blue);
      --bg-secondary: #0a1d33;
      --text-primary: #f0f0f0;
      --text-secondary: #b0b0b0;
      --accent: var(--lilac);
      --accent-secondary: var(--pink);
      --border: #1a3a5c;
      --card-bg: #132942;
      --shadow: rgba(0, 0, 0, 0.3);
    }
    
    /* ============================================
       RESET & BASE STYLES
       ============================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    button {
      font-family: inherit;
      cursor: pointer;
      border: none;
      background: none;
    }
    
    input, select {
      font-family: inherit;
      font-size: 1rem;
    }
    
    *:focus-visible {
      outline: 3px solid var(--accent);
      outline-offset: 2px;
    }
    
    /* ============================================
       HEADER
       ============================================ */
    .header {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px var(--shadow);
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      font-family: 'Allura', cursive;
      font-size: 2.5rem;
      color: var(--accent);
      text-decoration: none;
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .back-btn:hover {
      background: var(--bg-secondary);
      color: var(--accent);
    }
    
    /* ============================================
       MAIN CONTENT
       ============================================ */
    .main-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem 3rem;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
    }
    
    @media (max-width: 968px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      
      .summary-sidebar {
        order: -1;
      }
    }
    
    .card {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
    
    .card h2 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }
    
    .card h3 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }
    
    /* ============================================
       DELIVERY OPTIONS
       ============================================ */
    .delivery-options {
      display: grid;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .delivery-option {
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .delivery-option:hover {
      border-color: var(--accent);
      background: var(--bg-secondary);
    }
    
    .delivery-option.selected {
      border-color: var(--accent);
      background: var(--bg-secondary);
      box-shadow: 0 4px 15px rgba(255, 111, 181, 0.2);
    }
    
    .delivery-option input[type="radio"] {
      display: none;
    }
    
    .delivery-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      border-radius: 12px;
      color: var(--accent);
      flex-shrink: 0;
    }
    
    .delivery-content h4 {
      font-size: 1.2rem;
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }
    
    .delivery-content p {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    /* ============================================
       FORM ELEMENTS
       ============================================ */
    .address-section {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .address-section.visible {
      display: block;
    }
    
    .store-address {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      display: none;
    }
    
    .store-address.visible {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    .store-address h4 {
      color: var(--accent);
      margin-bottom: 0.5rem;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--accent);
    }
    
    .form-row {
      display: grid;
      gap: 1rem;
      grid-template-columns: 1fr 1fr;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    .frete-info {
      background: rgba(255, 152, 0, 0.1);
      border-left: 4px solid var(--warning);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    
    .frete-info.success {
      background: rgba(76, 175, 80, 0.1);
      border-left-color: var(--success);
    }
    
    .frete-info h4 {
      color: var(--warning);
      margin-bottom: 0.5rem;
    }
    
    .frete-info.success h4 {
      color: var(--success);
    }
    
    /* ============================================
       PAYMENT OPTIONS
       ============================================ */
    .payment-options {
      display: grid;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .payment-option {
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .payment-option:hover {
      border-color: var(--accent);
      background: var(--bg-secondary);
    }
    
    .payment-option.selected {
      border-color: var(--accent);
      background: var(--bg-secondary);
      box-shadow: 0 4px 15px rgba(255, 111, 181, 0.2);
    }
    
    .payment-option input[type="radio"] {
      display: none;
    }
    
    .payment-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      border-radius: 12px;
      color: var(--accent);
      flex-shrink: 0;
    }
    
    .payment-details h4 {
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }
    
    .payment-details p {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    /* ============================================
       SUMMARY SIDEBAR
       ============================================ */
    .summary-sidebar {
      position: sticky;
      top: 100px;
      height: fit-content;
    }
    
    .summary-card {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
    }
    
    .summary-card h3 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }
    
    .summary-items {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1.5rem;
      padding-right: 0.5rem;
    }
    
    .summary-item {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .summary-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .summary-item-img {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: var(--bg-secondary);
    }
    
    .summary-item-details {
      flex: 1;
    }
    
    .summary-item-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }
    
    .summary-item-qty {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .summary-item-price {
      font-weight: 700;
      color: var(--accent);
      text-align: right;
    }
    
    .summary-totals {
      margin-bottom: 1.5rem;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
      font-size: 0.95rem;
    }
    
    .summary-row.total {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      padding-top: 1rem;
      border-top: 2px solid var(--border);
    }
    
    .summary-row.frete {
      color: var(--warning);
    }
    
    .summary-row.frete.free {
      color: var(--success);
    }
    
    /* ============================================
       BUTTONS
       ============================================ */
    .btn-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .btn {
      flex: 1;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1.05rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--accent-secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 111, 181, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--border);
    }
    
    /* ============================================
       SUCCESS SCREEN
       ============================================ */
    .success-screen {
      display: none;
      text-align: center;
      padding: 3rem 1rem;
    }
    
    .success-screen.visible {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    .success-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 2rem;
      background: var(--success);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: scaleIn 0.5s ease;
    }
    
    @keyframes scaleIn {
      from {
        transform: scale(0);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .order-id-display {
      display: inline-block;
      background: var(--bg-secondary);
      padding: 0.5rem 1.5rem;
      border-radius: 8px;
      font-weight: 700;
      color: var(--accent);
      margin: 1.5rem 0;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="index.html" class="logo">Sublime</a>
      <button class="back-btn" onclick="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Voltar
      </button>
    </div>
  </header>
  
  <!-- Main Content -->
  <div class="main-container">
    
    <!-- Left Column - Forms -->
    <div id="checkout-content">
      
      <!-- Delivery Selection -->
      <div class="card" id="delivery-card">
        <h2>üöö Escolha o tipo de recebimento</h2>
        
        <div class="delivery-options">
          <label class="delivery-option" data-type="entrega">
            <input type="radio" name="delivery" value="entrega" onchange="selectDeliveryType('entrega')">
            <div class="delivery-icon">
              <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="1" y="3" width="15" height="13"></rect>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                <circle cx="18.5" cy="18.5" r="2.5"></circle>
              </svg>
            </div>
            <div class="delivery-content">
              <h4>Entrega em domic√≠lio</h4>
              <p>Receba seus produtos no conforto da sua casa</p>
            </div>
          </label>
          
          <label class="delivery-option" data-type="retirada">
            <input type="radio" name="delivery" value="retirada" onchange="selectDeliveryType('retirada')">
            <div class="delivery-icon">
              <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
            </div>
            <div class="delivery-content">
              <h4>Retirar na loja</h4>
              <p>Retire pessoalmente - Frete gr√°tis!</p>
            </div>
          </label>
        </div>
        
        <!-- Address Form -->
        <div class="address-section" id="address-form">
          <h3>Endere√ßo de entrega</h3>
          
          <form id="delivery-form">
            <div class="form-group">
              <label for="cep">CEP</label>
              <input type="text" id="cep" placeholder="00000-000" maxlength="9" oninput="handleCepInput(event)">
            </div>
            
            <div class="form-group">
              <label for="street">Rua</label>
              <input type="text" id="street" placeholder="Nome da rua">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="number">N√∫mero</label>
                <input type="text" id="number" placeholder="N¬∫">
              </div>
              <div class="form-group">
                <label for="complement">Complemento</label>
                <input type="text" id="complement" placeholder="Apto, bloco...">
              </div>
            </div>
            
            <div class="form-group">
              <label for="neighborhood">Bairro</label>
              <input type="text" id="neighborhood" placeholder="Bairro">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="city">Cidade</label>
                <input type="text" id="city" placeholder="Cidade">
              </div>
              <div class="form-group">
                <label for="state">Estado</label>
                <input type="text" id="state" placeholder="UF" maxlength="2">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="customer-name">Nome completo</label>
                <input type="text" id="customer-name" placeholder="Seu nome completo" required>
              </div>
              <div class="form-group">
                <label for="customer-phone">Telefone / WhatsApp</label>
                <input type="tel" id="customer-phone" placeholder="(00) 00000-0000" required>
              </div>
            </div>
          </form>
          
          <div class="frete-info" id="frete-info" style="display: none;"></div>
        </div>
        
        <!-- Store Address -->
        <div class="store-address" id="store-address">
          <h4>üìç Endere√ßo da loja</h4>
          <p><strong>Rua Itacy Rodovalho de Alencar, 110</strong></p>
          <p>CEP: 63504-460</p>
          <p class="mt-2" style="margin-top: 1rem;">Por favor, preencha seus dados para contato:</p>
          
          <form id="pickup-form" style="margin-top: 1rem;">
            <div class="form-group">
              <label for="pickup-name">Nome completo</label>
              <input type="text" id="pickup-name" placeholder="Seu nome completo" required>
            </div>
            
            <div class="form-group">
              <label for="pickup-phone">Telefone / WhatsApp</label>
              <input type="tel" id="pickup-phone" placeholder="(00) 00000-0000" required>
            </div>
          </form>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goBack()">Cancelar</button>
          <button class="btn btn-primary" onclick="proceedToPayment()" id="btn-proceed">
            Continuar
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Payment Selection (Hidden initially) -->
      <div class="card" id="payment-card" style="display: none;">
        <h2>üí≥ Forma de pagamento</h2>
        
        <div class="payment-options">
          <label class="payment-option" data-payment="pix">
            <input type="radio" name="payment" value="pix" onchange="selectPayment('pix')">
            <div class="payment-icon">
              <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
              </svg>
            </div>
            <div class="payment-details">
              <h4>Pix</h4>
              <p>Pagamento instant√¢neo e sem taxas</p>
            </div>
          </label>
          
          <label class="payment-option" data-payment="dinheiro">
            <input type="radio" name="payment" value="dinheiro" onchange="selectPayment('dinheiro')">
            <div class="payment-icon">
              <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
            </div>
            <div class="payment-details">
              <h4>Dinheiro</h4>
              <p>Pagamento em esp√©cie na entrega/retirada</p>
            </div>
          </label>
          
          <label class="payment-option" data-payment="credito">
            <input type="radio" name="payment" value="credito" onchange="selectPayment('credito')">
            <div class="payment-icon">
              <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
              </svg>
            </div>
            <div class="payment-details">
              <h4>Cart√£o de Cr√©dito</h4>
              <p>√Ä vista no cr√©dito</p>
            </div>
          </label>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="backToDelivery()">Voltar</button>
          <button class="btn btn-primary" onclick="finalizeOrder()" id="btn-finalize" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Finalizar Pedido
          </button>
        </div>
      </div>
      
      <!-- Success Screen -->
      <div class="card success-screen" id="success-screen">
        <div class="success-icon" id="success-icon">
          <div class="spinner"></div>
        </div>
        <div id="success-message"></div>
      </div>
      
    </div>
    
    <!-- Right Column - Summary -->
    <aside class="summary-sidebar">
      <div class="summary-card">
        <h3>Resumo do Pedido</h3>
        
        <div class="summary-items" id="summary-items">
          <!-- Dynamically rendered -->
        </div>
        
        <div class="summary-totals" id="summary-totals">
          <!-- Dynamically rendered -->
        </div>
      </div>
    </aside>
    
  </div>
  
  <script>
    /* ============================================
       CONFIGURATION
       ============================================ */
    const CONFIG = {
      STORE_ADDRESS: {
        street: 'Rua Itacy Rodovalho de Alencar',
        number: '110',
        cep: '63504-460',
        city: 'Iguatu',
        state: 'CE',
        lat: -6.3588, // PLACEHOLDER: coordenadas reais
        lng: -39.2978
      },
      
      // PLACEHOLDER: URL da API para salvar pedido
      API_ENDPOINT: 'https://your-api-endpoint.com/save-order'
    };
    
    /* ============================================
       STATE
       ============================================ */
    let checkoutState = {
      cart: [],
      deliveryType: null,
      deliveryData: {},
      paymentType: null,
      subtotal: 0,
      frete: 0,
      total: 0,
      distance: null
    };
    
    /* ============================================
       INITIALIZATION
       ============================================ */
    function initCheckout() {
      // Load cart data
      const checkoutData = localStorage.getItem('sublime_checkout_data');
      
      if (!checkoutData) {
        alert('Nenhum produto no carrinho. Voc√™ ser√° redirecionado.');
        window.location.href = 'index.html';
        return;
      }
      
      const data = JSON.parse(checkoutData);
      checkoutState.cart = data.cart;
      
      calculateSubtotal();
      renderSummary();
      
      // Load theme
      const savedTheme = localStorage.getItem('sublime_theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
      }
    }
    
    /* ============================================
       CALCULATIONS
       ============================================ */
    function calculateSubtotal() {
      checkoutState.subtotal = checkoutState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    }
    
    /**
     * Calcula o frete baseado na dist√¢ncia
     * TABELA DE FRETE:
     * 0km - 2.9km ‚Üí Gr√°tis
     * 3km - 4.9km ‚Üí R$ 2,00
     * 5km - 6.9km ‚Üí R$ 3,50
     * 7km - 8.5km ‚Üí R$ 5,00
     * 10km+ ‚Üí R$ 10,00
     * 
     * REGRAS ESPECIAIS:
     * - Compra >= R$ 300,00 ‚Üí Frete fixo R$ 10,00
     * - Compra <= R$ 100,00 ‚Üí Frete gr√°tis at√© 5km
     */
    function calculateFrete(distance, subtotal) {
      // Regra especial: compra >= R$ 300
      if (subtotal >= 300) {
        return { value: 10.00, rule: 'Compras acima de R$ 300,00 t√™m frete fixo de R$ 10,00' };
      }
      
      // Regra especial: compra <= R$ 100
      if (subtotal <= 100) {
        if (distance <= 5) {
          return { value: 0, rule: 'Frete gr√°tis para compras at√© R$ 100,00 em dist√¢ncias de at√© 5km! üéâ' };
        }
        // Se dist√¢ncia > 5km, aplica a tabela normal abaixo
      }
      
      // Tabela normal
      if (distance < 3) {
        return { value: 0, rule: 'Frete gr√°tis! üéâ' };
      } else if (distance < 5) {
        return { value: 2.00, rule: 'Frete para dist√¢ncia de 3-5km' };
      } else if (distance < 7) {
        return { value: 3.50, rule: 'Frete para dist√¢ncia de 5-7km' };
      } else if (distance <= 8.5) {
        return { value: 5.00, rule: 'Frete para dist√¢ncia de 7-8.5km' };
      } else {
        return { value: 10.00, rule: 'Frete para dist√¢ncia acima de 10km' };
      }
    }
    
    /**
     * PLACEHOLDER: Calcular dist√¢ncia entre dois endere√ßos
     * Substituir por integra√ß√£o com API de geocoding (Google Maps, etc)
     */
    async function calculateDistance(customerAddress) {
      // Simular delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // MOCK: Simular dist√¢ncia baseada em CEP
      // Em produ√ß√£o, usar API real de geocoding
      /*
      const response = await fetch('https://maps.googleapis.com/maps/api/distancematrix/json?...);
      const data = await response.json();
      return data.distance.value / 1000; // km
      */
      
      // Mock: Gerar dist√¢ncia aleat√≥ria para demonstra√ß√£o
      const mockDistance = Math.random() * 12;
      return mockDistance;
    }
    
    /* ============================================
       DELIVERY HANDLING
       ============================================ */
    function selectDeliveryType(type) {
      checkoutState.deliveryType = type;
      
      // Update UI
      document.querySelectorAll('.delivery-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.querySelector(`.delivery-option[data-type="${type}"]`).classList.add('selected');
      
      // Show/hide relevant sections
      const addressForm = document.getElementById('address-form');
      const storeAddress = document.getElementById('store-address');
      
      if (type === 'entrega') {
        addressForm.classList.add('visible');
        storeAddress.classList.remove('visible');
      } else {
        addressForm.classList.remove('visible');
        storeAddress.classList.add('visible');
        checkoutState.frete = 0;
        checkoutState.distance = 0;
        renderSummary();
      }
    }
    
    async function handleCepInput(event) {
      let value = event.target.value.replace(/\D/g, '');
      
      if (value.length > 5) {
        value = value.substring(0, 5) + '-' + value.substring(5, 8);
      }
      
      event.target.value = value;
      
      if (value.replace(/\D/g, '').length === 8) {
        await fetchAddressByCep(value);
        await calculateAndShowFrete();
      }
    }
    
    async function fetchAddressByCep(cep) {
      try {
        const cleanCep = cep.replace(/\D/g, '');
        const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
        const data = await response.json();
        
        if (data.erro) {
          return;
        }
        
        document.getElementById('street').value = data.logradouro || '';
        document.getElementById('neighborhood').value = data.bairro || '';
        document.getElementById('city').value = data.localidade || '';
        document.getElementById('state').value = data.uf || '';
      } catch (error) {
        console.error('Error fetching CEP:', error);
      }
    }
    
    async function calculateAndShowFrete() {
      const freteInfo = document.getElementById('frete-info');
      freteInfo.style.display = 'block';
      freteInfo.className = 'frete-info';
      freteInfo.innerHTML = '<p>Calculando frete...</p>';
      
      const customerAddress = {
        cep: document.getElementById('cep').value,
        street: document.getElementById('street').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value
      };
      
      try {
        // PLACEHOLDER: Calculate real distance
        const distance = await calculateDistance(customerAddress);
        checkoutState.distance = distance;
        
        const freteResult = calculateFrete(distance, checkoutState.subtotal);
        checkoutState.frete = freteResult.value;
        
        if (freteResult.value === 0) {
          freteInfo.className = 'frete-info success';
        }
        
        freteInfo.innerHTML = `
          <h4>Frete calculado</h4>
          <p><strong>Dist√¢ncia aproximada:</strong> ${distance.toFixed(1)} km</p>
          <p><strong>Valor do frete:</strong> ${freteResult.value === 0 ? 'Gr√°tis! üéâ' : `R$ ${freteResult.value.toFixed(2)}`}</p>
          <p style="font-size: 0.85rem; margin-top: 0.5rem;">${freteResult.rule}</p>
        `;
        
        renderSummary();
      } catch (error) {
        console.error('Error calculating frete:', error);
        freteInfo.className = 'frete-info';
        freteInfo.innerHTML = '<p>Erro ao calcular frete. Tente novamente.</p>';
      }
    }
    
    /* ============================================
       PAYMENT HANDLING
       ============================================ */
    function selectPayment(type) {
      checkoutState.paymentType = type;
      
      // Update UI
      document.querySelectorAll('.payment-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.querySelector(`.payment-option[data-payment="${type}"]`).classList.add('selected');
      
      document.getElementById('btn-finalize').disabled = false;
    }
    
    /* ============================================
       NAVIGATION
       ============================================ */
    async function proceedToPayment() {
      if (!checkoutState.deliveryType) {
        alert('Por favor, selecione o tipo de recebimento.');
        return;
      }
      
      if (checkoutState.deliveryType === 'entrega') {
        const cep = document.getElementById('cep').value.trim();
        const street = document.getElementById('street').value.trim();
        const number = document.getElementById('number').value.trim();
        const neighborhood = document.getElementById('neighborhood').value.trim();
        const city = document.getElementById('city').value.trim();
        const state = document.getElementById('state').value.trim();
        const name = document.getElementById('customer-name').value.trim();
        const phone = document.getElementById('customer-phone').value.trim();
        
        if (!cep || !street || !number || !neighborhood || !city || !state || !name || !phone) {
          alert('Por favor, preencha todos os campos de entrega.');
          return;
        }
        
        checkoutState.deliveryData = {
          type: 'entrega',
          cep,
          street,
          number,
          complement: document.getElementById('complement').value.trim(),
          neighborhood,
          city,
          state,
          name,
          phone
        };
        
        // Calculate frete if not done yet
        if (checkoutState.distance === null) {
          await calculateAndShowFrete();
        }
      } else {
        const name = document.getElementById('pickup-name').value.trim();
        const phone = document.getElementById('pickup-phone').value.trim();
        
        if (!name || !phone) {
          alert('Por favor, preencha seu nome e telefone.');
          return;
        }
        
        checkoutState.deliveryData = {
          type: 'retirada',
          name,
          phone
        };
        
        checkoutState.frete = 0;
      }
      
      // Hide delivery card, show payment card
      document.getElementById('delivery-card').style.display = 'none';
      document.getElementById('payment-card').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function backToDelivery() {
      document.getElementById('delivery-card').style.display = 'block';
      document.getElementById('payment-card').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    /* ============================================
       FINALIZE ORDER
       ============================================ */
    async function finalizeOrder() {
      if (!checkoutState.paymentType) {
        alert('Por favor, selecione uma forma de pagamento.');
        return;
      }
      
      // Hide forms, show loading
      document.getElementById('delivery-card').style.display = 'none';
      document.getElementById('payment-card').style.display = 'none';
      document.getElementById('success-screen').classList.add('visible');
      
      const successIcon = document.getElementById('success-icon');
      const successMessage = document.getElementById('success-message');
      
      successIcon.innerHTML = '<div class="spinner"></div>';
      successMessage.innerHTML = '<h2>Processando seu pedido...</h2><p>Aguarde um momento.</p>';
      
      const orderData = {
        cart: checkoutState.cart,
        delivery: checkoutState.deliveryData,
        payment: checkoutState.paymentType,
        subtotal: checkoutState.subtotal,
        frete: checkoutState.frete,
        total: checkoutState.subtotal + checkoutState.frete,
        timestamp: Date.now()
      };
      
      try {
        // PLACEHOLDER: Save order to database/spreadsheet
        const result = await saveOrder(orderData);
        
        if (result.success) {
          // Clear cart
          localStorage.removeItem('sublime_cart');
          localStorage.removeItem('sublime_checkout_data');
          
          // Save confirmation
          localStorage.setItem('sublime_order_confirmed', JSON.stringify({
            orderId: result.orderId,
            total: orderData.total
          }));
          
          // Show success
          successIcon.innerHTML = `
            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
          
          successMessage.innerHTML = `
            <h2>‚úì Pedido confirmado com sucesso! üéâ</h2>
            <p>Seu pedido foi reservado e em breve entraremos em contato.</p>
            
            <div class="order-id-display">${result.orderId}</div>
            
            <p style="margin-top: 1rem; color: var(--text-secondary);">
              Um vendedor entrar√° em contato para confirmar os detalhes.
            </p>
            
            <div class="btn-group" style="justify-content: center; margin-top: 2rem;">
              <button class="btn btn-primary" onclick="returnHome()">
                Voltar √† loja
              </button>
            </div>
          `;
        } else {
          throw new Error('Erro ao processar pedido');
        }
      } catch (error) {
        console.error('Error finalizing order:', error);
        
        successIcon.innerHTML = `
          <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        `;
        successIcon.style.background = 'var(--error)';
        
        successMessage.innerHTML = `
          <h2>Erro ao processar pedido</h2>
          <p>Ocorreu um erro. Por favor, tente novamente.</p>
          
          <div class="btn-group" style="justify-content: center; margin-top: 2rem;">
            <button class="btn btn-secondary" onclick="backToDelivery()">Tentar novamente</button>
          </div>
        `;
      }
    }
    
    /**
     * PLACEHOLDER: Salvar pedido na planilha/banco de dados
     * Substituir por integra√ß√£o real
     */
    async function saveOrder(orderData) {
      // Simular delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // MOCK: Em produ√ß√£o, fazer POST para API/Google Sheets
      /*
      const response = await fetch(CONFIG.API_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
      });
      
      const data = await response.json();
      return data;
      */
      
      // Mock success
      return {
        success: true,
        orderId: 'ORD-' + Date.now()
      };
    }
    
    /* ============================================
       RENDER FUNCTIONS
       ============================================ */
    function renderSummary() {
      // Items
      const itemsContainer = document.getElementById('summary-items');
      itemsContainer.innerHTML = checkoutState.cart.map(item => `
        <div class="summary-item">
          <img src="${item.image}" alt="${item.name}" class="summary-item-img">
          <div class="summary-item-details">
            <div class="summary-item-name">${item.name}</div>
            <div class="summary-item-qty">Quantidade: ${item.quantity}</div>
          </div>
          <div class="summary-item-price">R$ ${(item.price * item.quantity).toFixed(2)}</div>
        </div>
      `).join('');
      
      // Totals
      checkoutState.total = checkoutState.subtotal + checkoutState.frete;
      
      const totalsContainer = document.getElementById('summary-totals');
      totalsContainer.innerHTML = `
        <div class="summary-row">
          <span>Subtotal:</span>
          <span>R$ ${checkoutState.subtotal.toFixed(2)}</span>
        </div>
        
        <div class="summary-row frete ${checkoutState.frete === 0 ? 'free' : ''}">
          <span>Frete:</span>
          <span>${checkoutState.frete === 0 ? 'Gr√°tis üéâ' : `R$ ${checkoutState.frete.toFixed(2)}`}</span>
        </div>
        
        <div class="summary-row total">
          <span>Total:</span>
          <span>R$ ${checkoutState.total.toFixed(2)}</span>
        </div>
      `;
    }
    
    /* ============================================
       UTILITY FUNCTIONS
       ============================================ */
    function goBack() {
      if (confirm('Deseja cancelar a compra? Seus produtos permanecer√£o no carrinho.')) {
        window.location.href = 'index.html';
      }
    }
    
    function returnHome() {
      window.location.href = 'index.html';
    }
    
    /* ============================================
       START
       ============================================ */
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCheckout);
    } else {
      initCheckout();
    }
  </script>
  
</body>
</html>
